#!/bin/bash
. /home/modules.perl6.org/perl5/perlbrew/etc/bashrc
set -e -x
echo 'Starting module update'
date
cd ~/modules.perl6.org/

git fetch
before=$(git rev-parse HEAD)
git checkout origin/master
after=$(git rev-parse HEAD)
cp update-modules.perl6.org ../

DO_REBUILD=0
db_file="modulesperl6.db"
if [ "$before" != "$after" ]
then
    echo "Got new commits"
    if [[ `git log "$before"..."$after" --oneline` =~ '[REBUILD]' ]]; then
        echo "Full database rebuild triggered"
        DO_REBUILD=1
    fi
    if [[ `git log "$before"..."$after" --oneline` =~ '[NEWDB]' ]]; then
        db_file=$(mktemp)
        echo "New database creation requested; using $db_file as temp db"
    fi
fi

log_file=$(mktemp);
FULL_REBUILD=$DO_REBUILD perl bin/build-project-list.pl --restart-app \
    --db-file="$db_file" > "$log_file" 2>&1 && cp "$log_file" public/update.log

if [ "$db_file" != "modulesperl6.db" ]
then
    echo "Moving temp db to regular place"
    mv $db_file modulesperl6.db
fi

rm $log_file;
